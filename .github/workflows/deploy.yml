name: Deploy Workers

on:
  workflow_run:
    workflows: ['Verify']
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-staging:
    name: Deploy ${{ matrix.worker }} to staging
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    strategy:
      matrix:
        worker: [crane-context, crane-classifier]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For workflow_run, check out the commit that triggered Verify
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 2

      - name: Check for worker changes
        id: changes
        if: github.event_name == 'workflow_run'
        run: |
          # Compare against parent commit to detect worker-related changes
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          # Deploy if worker files, root config, or workflow itself changed
          if echo "$CHANGED" | grep -qE "^(workers/${{ matrix.worker }}/|package-lock\.json$|tsconfig\.json$|\.github/workflows/deploy\.yml$)"; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            echo "No relevant changes for ${{ matrix.worker }}, skipping deploy"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        if: steps.changes.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: workers/${{ matrix.worker }}/package-lock.json

      - name: Install dependencies
        if: steps.changes.outputs.skip != 'true'
        run: npm ci --prefix workers/${{ matrix.worker }}

      - name: Deploy to staging
        if: steps.changes.outputs.skip != 'true'
        run: npx wrangler deploy
        working-directory: workers/${{ matrix.worker }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  smoke-test:
    name: Smoke tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    # Run smoke tests unless BOTH workers were skipped
    if: >-
      !cancelled() && !failure()
    steps:
      - name: Wait for edge propagation
        run: sleep 5

      - name: Health check — crane-context-staging
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt: crane-context health check"
            if curl -sf https://crane-context-staging.automation-ab6.workers.dev/health | jq -e '.status == "healthy"'; then
              echo "crane-context-staging is healthy"
              exit 0
            fi
            echo "Retrying in 5s..."
            sleep 5
          done
          echo "crane-context-staging health check failed after 3 attempts"
          exit 1

      - name: Health check — crane-classifier-staging
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt: crane-classifier health check"
            if curl -sf https://crane-classifier-staging.automation-ab6.workers.dev/health | jq -e '.status == "healthy"'; then
              echo "crane-classifier-staging is healthy"
              exit 0
            fi
            echo "Retrying in 5s..."
            sleep 5
          done
          echo "crane-classifier-staging health check failed after 3 attempts"
          exit 1

      - name: D1 connectivity — crane-context-staging
        env:
          CRANE_CONTEXT_KEY: ${{ secrets.CRANE_CONTEXT_KEY }}
        run: |
          for attempt in 1 2 3; do
            echo "Attempt $attempt: D1 connectivity check"
            if curl -sf \
              -H "X-Relay-Key: $CRANE_CONTEXT_KEY" \
              "https://crane-context-staging.automation-ab6.workers.dev/active?venture=vc&repo=venturecrane/crane-console&agent=ci-smoke-test" \
              | jq -e '.sessions'; then
              echo "D1 connectivity verified"
              exit 0
            fi
            echo "Retrying in 5s..."
            sleep 5
          done
          echo "D1 connectivity check failed after 3 attempts"
          exit 1

  deploy-production:
    name: Deploy ${{ matrix.worker }} to production
    runs-on: ubuntu-latest
    needs: smoke-test
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'production'
    environment: production
    strategy:
      matrix:
        worker: [crane-context, crane-classifier]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: workers/${{ matrix.worker }}/package-lock.json

      - name: Install dependencies
        run: npm ci --prefix workers/${{ matrix.worker }}

      - name: Deploy to production
        run: npx wrangler deploy --env production
        working-directory: workers/${{ matrix.worker }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
