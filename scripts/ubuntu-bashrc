# ~/.bashrc: executed by bash(1) for non-login shells.

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# History settings
HISTCONTROL=ignoreboth
HISTSIZE=1000
HISTFILESIZE=2000
shopt -s histappend
shopt -s checkwinsize

# Enable color support
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
fi

# Aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# Crane Context API Key
export CRANE_CONTEXT_KEY="0216e886dbe2c31cd5ff0b8f6f46d954177e77b168a690e111bf67cfcc7062e8"

# ccs - Switch between repos
# Fetches venture list from crane-context API with fallback
ccs() {
    local base_dir="$HOME/dev"
    local api_url="${CRANE_CONTEXT_URL:-https://crane-context.automation-ab6.workers.dev}"
    local cache_file="/tmp/crane-ventures.json"
    local cache_ttl=86400  # 24 hours
    mkdir -p "$base_dir"

    # Fetch orgs from API, cache, or fallback
    local ventures orgs=()
    if ventures=$(curl -sS --max-time 5 "$api_url/ventures" 2>/dev/null) && echo "$ventures" | jq -e '.ventures' >/dev/null 2>&1; then
        echo "$ventures" | jq '.ventures' > "$cache_file" 2>/dev/null
        mapfile -t orgs < <(echo "$ventures" | jq -r '.ventures[].org')
    elif [[ -f "$cache_file" ]]; then
        mapfile -t orgs < <(jq -r '.[].org' "$cache_file" 2>/dev/null)
    else
        # Embedded fallback
        orgs=("venturecrane" "siliconcrane" "durganfieldguide" "kidexpenses" "smd-ventures" "draftcrane")
    fi

    local all_repos=()
    for org in "${orgs[@]}"; do
        local org_repos=$(gh repo list "$org" --limit 100 --json nameWithOwner,isArchived \
            --jq '.[] | select(.isArchived == false) | .nameWithOwner' 2>/dev/null)
        if [[ -n "$org_repos" ]]; then
            while IFS= read -r repo; do
                [[ -n "$repo" ]] && all_repos+=("$repo")
            done <<< "$org_repos"
        fi
    done

    if [[ ${#all_repos[@]} -eq 0 ]]; then
        echo "Error: No repos found or API error"
        return 1
    fi

    local menu_items=()
    local i=1
    for repo in "${all_repos[@]}"; do
        local repo_name="${repo#*/}"
        local local_path="$base_dir/$repo_name"
        if [[ -d "$local_path" ]]; then
            menu_items+=("$i) $repo")
        else
            menu_items+=("$i) $repo [not cloned]")
        fi
        ((i++))
    done

    echo "Select repo:"
    printf "  %s\n" "${menu_items[@]}"
    echo -n "Enter number (or q to quit): "
    read selection

    if [[ "$selection" == "q" ]]; then
        return 0
    fi

    if ! [[ "$selection" =~ ^[0-9]+$ ]] || (( selection < 1 || selection > ${#all_repos[@]} )); then
        echo "Invalid selection"
        return 1
    fi

    # Fixed: Arrays are zero-indexed, so subtract 1 from user selection
    local selected_repo="${all_repos[$((selection - 1))]}"
    local repo_name="${selected_repo#*/}"
    local target_dir="$base_dir/$repo_name"

    echo "â†’ $selected_repo"

    if [[ ! -d "$target_dir" ]]; then
        echo -n "Repo not cloned locally. Clone now? (y/n): "
        read should_clone
        if [[ "$should_clone" =~ ^[Yy]$ ]]; then
            echo "Cloning $selected_repo..."
            if git clone "git@github.com:$selected_repo.git" "$target_dir"; then
                echo "Cloned successfully"
            else
                echo "Clone failed"
                return 1
            fi
        else
            echo "Cancelled"
            return 1
        fi
    fi

    cd "$target_dir" || return 1
    echo "Now in: $(pwd)"
    claude
}

# Prompt
PS1='\u@\h:\w\$ '
